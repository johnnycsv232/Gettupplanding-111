rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // INVARIANT: Deny-All Firebase (See docs/invariants.md)
    // All collections start with deny all. Access granted via tested rules only.
    
    match /{document=**} {
      allow read, write: if false;
    }
    
    // === TESTED ACCESS RULES BELOW ===
    // Each rule must have a corresponding test in tests/security.test.ts
    
    // Users collection - authenticated users can read/write their own data
    // INVARIANT: Users cannot self-upgrade their subscription tier
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['subscriptionTier', 'stripeCustomerId', 'hasActiveSubscription', 'subscriptionStatus']);
      allow create: if request.auth != null && request.auth.uid == userId
                    && !request.resource.data.keys()
                        .hasAny(['subscriptionTier', 'stripeCustomerId', 'hasActiveSubscription', 'subscriptionStatus']);
    }
    
    // Subscriptions collection - authenticated users can read their own subscription
    match /subscriptions/{subscriptionId} {
      allow read: if request.auth != null && 
                    resource.data.userId == request.auth.uid;
      // Only server (admin SDK) can write subscriptions via webhooks
      allow write: if false;
    }
    
    // Proof packs - users can read their own, only server can write
    match /proofPacks/{proofPackId} {
      allow read: if request.auth != null && 
                    resource.data.userId == request.auth.uid;
      allow write: if false;
    }

    // Leads collection - allow unauthenticated create for landing page forms
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if false;
    }
  }
}
